# {{ ansible_managed }}

# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

# interfaces(5) file used by ifup(8) and ifdown(8)
# Include files from /etc/network/interfaces.d:
source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# Interfaces set to manual configuration
{% for interface in hostvars[inventory_hostname]['ansible_interfaces'] %}
{% if interface != 'lo' %}
iface {{ interface }} inet manual
{% endif %}
{% endfor %}

# Home Network/Private Network
auto vmbr0
iface vmbr0 inet static
    address {{ ansible_default_ipv4.address|default(ansible_all_ipv4_addresses[0]) }}/{{ (ansible_default_ipv4.address + '/' + ansible_default_ipv4.netmask) | ansible.utils.ipaddr('prefix') }}
    gateway {{ ansible_default_ipv4.gateway|default(ansible_all_ipv4_addresses[0]) }}
    bridge-ports {{ ansible_default_ipv4.interface }}
    bridge-stp off
    bridge-fd 0

# NAT
auto vmbr1
iface vmbr1 inet static
    address 172.16.0.1/12
    bridge-ports none
    bridge-stp off
    bridge-fd 0
    post-up echo 1 > /proc/sys/net/ipv4/ip_forward
    post-up   iptables -t nat -A POSTROUTING -s '172.16.0.0/12' -o vmbr0 -j MASQUERADE
    post-down iptables -t nat -D POSTROUTING -s '172.16.0.0/12' -o vmbr0 -j MASQUERADE
